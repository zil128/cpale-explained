<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - CPALE Explained</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#7C3AED',
                        secondary: '#10B981',
                        accent: '#F472B6',
                        lavender: '#FDF4FF',
                    },
                    fontFamily: {
                        heading: ['Space Grotesk', 'sans-serif'],
                        body: ['Plus Jakarta Sans', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        h1, h2, h3 { font-family: 'Space Grotesk', sans-serif; }
        
        .glass {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .stat-card {
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-lavender via-white to-blue-50 min-h-screen">

    <!-- Navigation -->
    <nav class="glass sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <h1 class="font-heading text-xl font-bold bg-gradient-to-r from-primary to-accent bg-clip-text text-transparent">
                    CPALE Admin
                </h1>
                <span class="px-2 py-1 bg-red-500 text-white text-xs font-bold rounded">ADMIN</span>
            </div>
            <div class="flex items-center space-x-4">
                <button onclick="refreshData()" class="text-gray-600 hover:text-primary transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                </button>
                <a href="dashboard.html" class="text-gray-600 hover:text-primary transition">User View</a>
                <button onclick="logout()" class="text-gray-600 hover:text-primary transition">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-6 py-10">
        
        <!-- Stats Overview -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="stat-card glass rounded-2xl p-6">
                <div class="flex items-center justify-between mb-2">
                    <p class="text-sm text-gray-600">Total Users</p>
                    <svg class="w-8 h-8 text-primary" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                    </svg>
                </div>
                <p class="text-3xl font-bold text-gray-900" id="totalUsers">0</p>
                <p class="text-xs text-gray-500 mt-1">All registered users</p>
            </div>

            <div class="stat-card glass rounded-2xl p-6">
                <div class="flex items-center justify-between mb-2">
                    <p class="text-sm text-gray-600">Paid Subscribers</p>
                    <svg class="w-8 h-8 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <p class="text-3xl font-bold text-green-600" id="paidUsers">0</p>
                <p class="text-xs text-gray-500 mt-1">Active paid plans</p>
            </div>

            <div class="stat-card glass rounded-2xl p-6">
                <div class="flex items-center justify-between mb-2">
                    <p class="text-sm text-gray-600">Monthly Revenue</p>
                    <svg class="w-8 h-8 text-accent" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"/>
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <p class="text-3xl font-bold text-accent" id="monthlyRevenue">₱0</p>
                <p class="text-xs text-gray-500 mt-1">Current month</p>
            </div>

            <div class="stat-card glass rounded-2xl p-6">
                <div class="flex items-center justify-between mb-2">
                    <p class="text-sm text-gray-600">Pending Payments</p>
                    <svg class="w-8 h-8 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <p class="text-3xl font-bold text-yellow-600" id="pendingPayments">0</p>
                <p class="text-xs text-gray-500 mt-1">Awaiting verification</p>
            </div>
        </div>

        <!-- Pending Payments Section -->
        <div class="glass rounded-3xl p-8 mb-8">
            <div class="flex items-center justify-between mb-6">
                <h2 class="font-heading text-2xl font-bold text-gray-900">Pending Payment Verifications</h2>
                <button onclick="loadPendingPayments()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition">
                    Refresh
                </button>
            </div>

            <div id="pendingPaymentsList" class="space-y-4">
                <div class="text-center py-8 text-gray-500">
                    <p>Loading...</p>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="grid md:grid-cols-2 gap-6">
            <!-- Recent Subscriptions -->
            <div class="glass rounded-3xl p-8">
                <h2 class="font-heading text-xl font-bold text-gray-900 mb-6">Recent Subscriptions</h2>
                <div id="recentSubscriptions" class="space-y-3">
                    <div class="text-center py-8 text-gray-500">
                        <p>Loading...</p>
                    </div>
                </div>
            </div>

            <!-- Conversion Metrics -->
            <div class="glass rounded-3xl p-8">
                <h2 class="font-heading text-xl font-bold text-gray-900 mb-6">Conversion Metrics</h2>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Conversion Rate</span>
                        <span class="text-2xl font-bold text-primary" id="conversionRate">0%</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Avg. Days to Convert</span>
                        <span class="text-2xl font-bold text-gray-900" id="avgDaysToConvert">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Total Conversions</span>
                        <span class="text-2xl font-bold text-green-600" id="totalConversions">0</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Payment Verification Modal -->
    <div id="verificationModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
        <div class="glass rounded-3xl max-w-4xl w-full p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-start mb-6">
                <h3 class="text-2xl font-bold text-gray-800">Verify Payment</h3>
                <button onclick="closeVerificationModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <div id="paymentDetails" class="space-y-6">
                <!-- Payment details will be populated here -->
            </div>

            <div class="mt-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Verification Notes</label>
                <textarea id="verificationNotes" rows="3" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:outline-none focus:border-primary" placeholder="Add any notes about this verification..."></textarea>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="verifyPayment('approve')" class="flex-1 py-3 px-6 bg-gradient-to-r from-green-500 to-green-600 text-white font-bold rounded-xl hover:shadow-lg transition">
                    Approve Payment
                </button>
                <button onclick="verifyPayment('reject')" class="flex-1 py-3 px-6 bg-gradient-to-r from-red-500 to-red-600 text-white font-bold rounded-xl hover:shadow-lg transition">
                    Reject Payment
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        const token = localStorage.getItem('token');
        let currentPaymentId = null;

        if (!token) {
            window.location.href = '/login.html';
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        // Load dashboard statistics
        async function loadStats() {
            try {
                const response = await fetch(`${API_URL}/analytics/dashboard`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Update overview stats
                    document.getElementById('totalUsers').textContent = data.overview.total_users.toLocaleString();
                    document.getElementById('paidUsers').textContent = data.overview.paid_subscribers.toLocaleString();
                    document.getElementById('monthlyRevenue').textContent = '₱' + data.overview.monthly_revenue.toLocaleString();
                    document.getElementById('pendingPayments').textContent = data.overview.pending_payments;

                    // Update conversion metrics
                    document.getElementById('conversionRate').textContent = data.conversion.conversion_rate + '%';
                    document.getElementById('avgDaysToConvert').textContent = data.conversion.avg_days_to_convert;
                    document.getElementById('totalConversions').textContent = data.conversion.total_conversions;

                    // Display recent subscriptions
                    displayRecentSubscriptions(data.recent_subscriptions);
                } else {
                    console.error('Failed to load stats');
                    // Set placeholders
                    document.getElementById('totalUsers').textContent = '-';
                    document.getElementById('paidUsers').textContent = '-';
                    document.getElementById('monthlyRevenue').textContent = '₱-';
                    document.getElementById('conversionRate').textContent = '-%';
                    document.getElementById('avgDaysToConvert').textContent = '-';
                    document.getElementById('totalConversions').textContent = '-';
                }

            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        function displayRecentSubscriptions(subscriptions) {
            const container = document.getElementById('recentSubscriptions');
            
            if (!subscriptions || subscriptions.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <p>No recent activity</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = subscriptions.map(sub => {
                const date = new Date(sub.created_at).toLocaleDateString();
                const actionColors = {
                    'CREATED': 'bg-blue-100 text-blue-700',
                    'UPGRADED': 'bg-green-100 text-green-700',
                    'RENEWED': 'bg-purple-100 text-purple-700'
                };

                return `
                    <div class="flex items-center justify-between p-3 bg-white/50 rounded-lg">
                        <div class="flex-1">
                            <p class="font-semibold text-gray-900">${sub.displayName || sub.email}</p>
                            <p class="text-xs text-gray-500">${date}</p>
                        </div>
                        <span class="px-3 py-1 ${actionColors[sub.action_type] || 'bg-gray-100 text-gray-700'} text-xs font-bold rounded-full">
                            ${sub.action_type}
                        </span>
                    </div>
                `;
            }).join('');
        }

        // Load pending payments
        async function loadPendingPayments() {
            try {
                const response = await fetch(`${API_URL}/payment/admin/pending`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayPendingPayments(data.payments || []);
                    document.getElementById('pendingPayments').textContent = data.payments?.length || 0;
                }
            } catch (error) {
                console.error('Failed to load pending payments:', error);
            }
        }

        function displayPendingPayments(payments) {
            const container = document.getElementById('pendingPaymentsList');
            
            if (payments.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <p>No pending payments</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = payments.map(payment => {
                const date = new Date(payment.created_at).toLocaleString();
                
                return `
                    <div class="bg-white/50 rounded-xl p-6 hover:shadow-lg transition cursor-pointer" onclick="openVerificationModal(${payment.payment_id})">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <p class="font-bold text-gray-900">${payment.displayName || 'Unknown User'}</p>
                                    <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs font-bold rounded">${payment.payment_status}</span>
                                </div>
                                <p class="text-sm text-gray-600">${payment.email}</p>
                                <p class="text-xs text-gray-500 mt-1">Submitted: ${date}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-2xl font-bold text-primary">₱${payment.amount.toFixed(2)}</p>
                                <p class="text-sm text-gray-600">${payment.payment_method}</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <p class="text-gray-500">Reference</p>
                                <p class="font-mono text-gray-900">${payment.transaction_ref || 'N/A'}</p>
                            </div>
                            <div>
                                <p class="text-gray-500">Payer Name</p>
                                <p class="text-gray-900">${payment.payer_name || 'N/A'}</p>
                            </div>
                            <div>
                                <p class="text-gray-500">Contact</p>
                                <p class="text-gray-900">${payment.payer_contact || 'N/A'}</p>
                            </div>
                            <div>
                                <p class="text-gray-500">User ID</p>
                                <p class="text-gray-900">#${payment.user_id}</p>
                            </div>
                        </div>

                        ${payment.payment_notes ? `
                            <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                                <p class="text-xs text-gray-500 mb-1">Notes:</p>
                                <p class="text-sm text-gray-700">${payment.payment_notes}</p>
                            </div>
                        ` : ''}

                        <div class="mt-4">
                            <button class="w-full py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition">
                                View Payment Proof & Verify
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openVerificationModal(paymentId) {
            currentPaymentId = paymentId;
            // In a real implementation, fetch detailed payment info here
            document.getElementById('verificationModal').classList.remove('hidden');
            document.getElementById('verificationModal').classList.add('flex');
        }

        function closeVerificationModal() {
            document.getElementById('verificationModal').classList.add('hidden');
            document.getElementById('verificationModal').classList.remove('flex');
            currentPaymentId = null;
        }

        async function verifyPayment(action) {
            if (!currentPaymentId) return;

            const notes = document.getElementById('verificationNotes').value;

            if (!confirm(`Are you sure you want to ${action} this payment?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/payment/admin/${currentPaymentId}/verify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        action: action,
                        verification_notes: notes
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert(`Payment ${action}d successfully!`);
                    closeVerificationModal();
                    loadPendingPayments();
                    loadStats();
                } else {
                    alert(data.error || `Failed to ${action} payment`);
                }
            } catch (error) {
                console.error('Verification error:', error);
                alert('Failed to process verification');
            }
        }

        function refreshData() {
            loadStats();
            loadPendingPayments();
        }

        // Initialize
        loadStats();
        loadPendingPayments();

        // Auto-refresh every 30 seconds
        setInterval(refreshData, 30000);
    </script>
</body>
</html>
